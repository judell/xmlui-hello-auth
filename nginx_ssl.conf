user                    www-data;
worker_processes        auto;

pid                     /run/nginx.pid;
include                 /etc/nginx/modules-enabled/*.conf;

events                  {
    worker_connections  768;
}

http                    {
    sendfile            on;
    tcp_nopush          on;
    types_hash_max_size 2048;
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    access_log          /var/log/nginx/access.log;
    error_log           /var/log/nginx/error.log;

    gzip                on;

    limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;

    # HTTPS Server Block
    server {
        listen 443 ssl http2;
        server_name hn.jonudell.info;

        # SSL Configuration
        ssl_certificate /etc/letsencrypt/live/hn.jonudell.info/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/hn.jonudell.info/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        # xmlui-github location
        location /xmlui-github/ {
            # Strip the /xmlui-github prefix
            rewrite ^/xmlui-github(/.*)$ $1 break;
            
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            
            # Handle SPA routing - if backend returns 404, try serving root
            proxy_intercept_errors on;
            error_page 404 = /xmlui-github/;
        }

        location /xmlui-hello-auth/ {
            rewrite ^/xmlui-hello-auth(/.*)$ $1 break;
            
            proxy_pass http://127.0.0.1:8081;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            
            # Handle SPA routing - if backend returns 404, try serving root
            proxy_intercept_errors on;
            error_page 404 = /xmlui-hello-auth/;
        }

        # xmlui-hello-auth proxy location (more specific)
        location ~ ^/xmlui-hello-auth/proxy/([^/]+)/(.+)$ {
            resolver 1.1.1.1 1.0.0.1 valid=300s;
            set $dest https://$1/$2;
            proxy_pass $dest;
            proxy_ssl_server_name on;
            proxy_set_header Host $proxy_host;
            
            # CRITICAL: Forward all headers including Authorization
            proxy_pass_request_headers on;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # HTTP Server Block (redirect to HTTPS)
    server {
        listen 80;
        server_name hn.jonudell.info;
        
        # Redirect all HTTP requests to HTTPS
        return 301 https://$server_name$request_uri;
    }
}


