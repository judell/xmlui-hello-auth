(function(h,A){typeof exports=="object"&&typeof module<"u"?module.exports=A(require("react/jsx-runtime"),require("xmlui"),require("react")):typeof define=="function"&&define.amd?define(["react/jsx-runtime","xmlui","react"],A):(h=typeof globalThis<"u"?globalThis:h||self,h["xmlui-hello-auth"]=A(h.jsxRuntime,h.xmlui,h.React))})(this,function(h,A,r){"use strict";function $(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}async function z(e){const t=$(e),n=await crypto.subtle.digest("SHA-256",t);return new Uint8Array(n)}function E(e){let t="";for(let a=0;a<e.length;a++)t+=String.fromCharCode(e[a]);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function B(e){return new TextEncoder().encode(e)}function I(e=32){const t=new Uint8Array(e);return crypto.getRandomValues(t),E(t)}async function D(){const e=I(32),t=await z(B(e)),n=E(t);return{verifier:e,challenge:n}}function P(e){return e==="local"?window.localStorage:window.sessionStorage}const g={scopes:"openid email profile",storage:"session",autoLogin:!1,debug:!0},M=r.forwardRef(function({issuer:t,client_id:n,redirect_uri:a,scopes:m=g.scopes,storage:u=g.storage,autoLogin:_=g.autoLogin,debug:s=g.debug,proxy_base_url:d,registerComponentApi:w,updateState:k},q){const[T]=r.useState("idle"),[J,N]=r.useState(void 0),[b,L]=r.useState(void 0),[F,y]=r.useState(void 0),[W,R]=r.useState(void 0),x=r.useMemo(()=>`xmlui.auth:${t||"unknown"}:${n||"unknown"}`,[t,n]),X=r.useMemo(()=>({issuer:t,client_id:n,redirect_uri:a,scopes:m,storage:u,autoLogin:_,proxy_base_url:d}),[t,n,a,m,u,_,d]);function p(){const i={status:T,echo:X,endpoints:b,error:F,temp:W,lastPokeAt:J};s&&console.debug("[HelloAuth] publish →",i),k==null||k(i)}r.useEffect(()=>{try{const i=new URL(window.location.href),S=i.searchParams,l=S.get("code"),O=S.get("state");if(!l)return;const f=P(u).getItem(x),o=f?JSON.parse(f):void 0;if(!o||!o.state||O!==o.state){s&&console.warn("[HelloAuth] callback: state mismatch or missing stash"),y({code:"redirect_state_mismatch",message:"State returned by the provider does not match the stored state.",details:{returnedState:O,expectedState:o==null?void 0:o.state}}),R(void 0),i.search="",window.history.replaceState({},document.title,i.toString()),setTimeout(p,0);return}y(void 0),R({code_verifier:o.code_verifier,state:o.state,nonce:o.nonce,code:l}),s&&console.debug("[HelloAuth] callback ✓ code captured"),i.search="",window.history.replaceState({},document.title,i.toString()),setTimeout(p,0)}catch(i){s&&console.warn("[HelloAuth] callback error",i)}},[x,u,s]);const U=r.useRef(null);return r.useEffect(()=>{var f;if(L(void 0),y(void 0),!t){p();return}const S=`${t.replace(/\/+$/,"")}/.well-known/openid-configuration`,l=(d==null?void 0:d.replace(/\/+$/,""))||void 0,O=S.replace(/^https?:\/\//,""),v=l?`${l}/${O}`:S;(f=U.current)==null||f.abort(),U.current=new AbortController,(async()=>{try{s&&console.debug("[HelloAuth] discovery →",v);const o=await fetch(v,{signal:U.current.signal});if(!o.ok)throw new Error(`HTTP ${o.status}`);const c=await o.json(),H={issuer:c.issuer,authorization_endpoint:c.authorization_endpoint,token_endpoint:c.token_endpoint,jwks_uri:c.jwks_uri,userinfo_endpoint:c.userinfo_endpoint,end_session_endpoint:c.end_session_endpoint||c.end_session_endpoint_url};s&&console.debug("[HelloAuth] discovery ✓",H),L(H),y(void 0),setTimeout(p,0)}catch(o){if((o==null?void 0:o.name)==="AbortError")return;const c={code:"discovery_failed",message:"Failed to load OIDC discovery document",details:String((o==null?void 0:o.message)||o)};s&&console.warn("[HelloAuth] discovery ✗",c),L(void 0),y(c),setTimeout(p,0)}})()},[t,d]),r.useEffect(()=>{const i=()=>{const l=new Date().toISOString();s&&console.debug("[HelloAuth] poke()",l),N(l),setTimeout(p,0)},S=async()=>{var j;if(!(b!=null&&b.authorization_endpoint)||!n||!a){s&&console.warn("[HelloAuth] login(): missing config"),y({code:"config_missing",message:"issuer/client_id/redirect_uri or endpoints are missing"}),setTimeout(p,0);return}if(!((j=window.crypto)!=null&&j.subtle)){y({code:"unknown",message:"Web Crypto not available"}),setTimeout(p,0);return}const{verifier:l,challenge:O}=await D(),v=I(16),f=I(16),o=P(u),c={code_verifier:l,state:v,nonce:f,redirect_uri:a,client_id:n};o.setItem(x,JSON.stringify(c));const H=new URL(b.authorization_endpoint),G=new URLSearchParams({response_type:"code",client_id:n,redirect_uri:a,scope:m||"openid",state:v,nonce:f,code_challenge:O,code_challenge_method:"S256"});H.search=G.toString();const C=H.toString();s&&console.debug("[HelloAuth] built authorize URL:",C),R({code_verifier:l,state:v,nonce:f}),setTimeout(p,0),window.location.assign(C)};w==null||w({poke:i,login:S})},[w,b,n,a,m,u,x,s]),null}),K=A.createMetadata({description:"`HelloAuth` is a headless auth service (no UI).",status:"experimental",props:{issuer:{description:"OIDC issuer.",type:"string",isRequired:!1},client_id:{description:"OIDC client id.",type:"string",isRequired:!1},redirect_uri:{description:"Redirect URI.",type:"string",isRequired:!1},scopes:{description:"Scopes (space-separated).",type:"string",isRequired:!1,defaultValue:g.scopes},storage:{description:"session | local",type:"string",isRequired:!1,defaultValue:g.storage},autoLogin:{description:"Attempt start on mount.",type:"boolean",isRequired:!1,defaultValue:g.autoLogin},debug:{description:"Console debug.",type:"boolean",isRequired:!1,defaultValue:g.debug},proxy_base_url:{description:"Optional proxy base, e.g. 'http://localhost:8080/proxy/'. If present, discovery and (later) token calls go through it.",type:"string",isRequired:!1},id:{description:"Component id.",type:"string",isRequired:!1}},events:{},apis:{poke:{description:"Update lastPokeAt in state.",type:"function"},login:{description:"Start OIDC Authorization Code + PKCE redirect.",type:"function"}}});return{namespace:"XMLUIExtensions",components:[A.createComponentRenderer("HelloAuth",K,({node:e,extractValue:t,registerComponentApi:n,updateState:a})=>{var m,u,_,s,d,w,k,q,T;return h.jsx(M,{id:t.asOptionalString((m=e.props)==null?void 0:m.id),issuer:t.asOptionalString((u=e.props)==null?void 0:u.issuer),client_id:t.asOptionalString((_=e.props)==null?void 0:_.client_id),redirect_uri:t.asOptionalString((s=e.props)==null?void 0:s.redirect_uri),scopes:t.asOptionalString((d=e.props)==null?void 0:d.scopes),storage:t.asOptionalString((w=e.props)==null?void 0:w.storage),autoLogin:t.asOptionalBoolean((k=e.props)==null?void 0:k.autoLogin),debug:t.asOptionalBoolean((q=e.props)==null?void 0:q.debug),proxy_base_url:t.asOptionalString((T=e.props)==null?void 0:T.proxy_base_url),registerComponentApi:n,updateState:a})})]}});typeof window.xmlui<"u"&&window.xmlui.standalone.registerExtension(window["xmlui-hello-auth"].default||window["xmlui-hello-auth"]);
