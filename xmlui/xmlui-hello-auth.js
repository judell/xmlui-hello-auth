(function(l,f){typeof exports=="object"&&typeof module<"u"?module.exports=f(require("react/jsx-runtime"),require("xmlui"),require("react")):typeof define=="function"&&define.amd?define(["react/jsx-runtime","xmlui","react"],f):(l=typeof globalThis<"u"?globalThis:l||self,l["xmlui-hello-auth"]=f(l.jsxRuntime,l.xmlui,l.React))})(this,function(l,f,o){"use strict";function M(s){return s==="local"?window.localStorage:window.sessionStorage}const d={scopes:"openid email profile",storage:"session",autoLogin:!1,debug:!0},T=o.forwardRef(function({issuer:t,client_id:h,redirect_uri:A,scopes:m=d.scopes,storage:u=d.storage,autoLogin:w=d.autoLogin,debug:n=d.debug,proxy_base_url:a,registerComponentApi:p,updateState:g},H){const[O]=o.useState("idle"),[I,D]=o.useState(void 0),[E,b]=o.useState(void 0),[j,y]=o.useState(void 0),[L,P]=o.useState(void 0),$=o.useMemo(()=>`xmlui.auth:${t||"unknown"}:${h||"unknown"}`,[t,h]),R=o.useMemo(()=>({issuer:t,client_id:h,redirect_uri:A,scopes:m,storage:u,autoLogin:w,proxy_base_url:a}),[t,h,A,m,u,w,a]);function v(){g==null||g({status:O,echo:R,endpoints:E,error:j,temp:L,lastPokeAt:I})}o.useEffect(()=>{try{const i=new URL(window.location.href),c=i.searchParams,S=c.get("code"),_=c.get("state");if(!S)return;const k=M(u).getItem($),e=k?JSON.parse(k):void 0;if(!e||!e.state||_!==e.state){n&&console.warn("[HelloAuth] callback: state mismatch or missing stash"),y({code:"redirect_state_mismatch",message:"State returned by the provider does not match the stored state.",details:{returnedState:_,expectedState:e==null?void 0:e.state}}),P(void 0),i.search="",window.history.replaceState({},document.title,i.toString()),v();return}y(void 0),P({code_verifier:e.code_verifier,state:e.state,nonce:e.nonce,code:S}),n&&console.debug("[HelloAuth] callback ✓ code captured"),i.search="",window.history.replaceState({},document.title,i.toString()),v()}catch(i){n&&console.warn("[HelloAuth] callback error",i)}},[$,u,n]);const q=o.useRef(null);return o.useEffect(()=>{var k;if(b(void 0),y(void 0),!t){v();return}const c=`${t.replace(/\/+$/,"")}/.well-known/openid-configuration`,S=(a==null?void 0:a.replace(/\/+$/,""))||void 0,_=c.replace(/^https?:\/\//,""),x=S?`${S}/${_}`:c;(k=q.current)==null||k.abort(),q.current=new AbortController,(async()=>{try{n&&console.debug("[HelloAuth] discovery →",x);const e=await fetch(x,{signal:q.current.signal});if(!e.ok)throw new Error(`HTTP ${e.status}`);const r=await e.json(),U={issuer:r.issuer,authorization_endpoint:r.authorization_endpoint,token_endpoint:r.token_endpoint,jwks_uri:r.jwks_uri,userinfo_endpoint:r.userinfo_endpoint,end_session_endpoint:r.end_session_endpoint||r.end_session_endpoint_url};n&&console.debug("[HelloAuth] discovery ✓",U),b(U),y(void 0)}catch(e){if((e==null?void 0:e.name)==="AbortError")return;const r={code:"discovery_failed",message:"Failed to load OIDC discovery document",details:String((e==null?void 0:e.message)||e)};n&&console.warn("[HelloAuth] discovery ✗",r),b(void 0),y(r)}finally{v()}})()},[t,a]),o.useEffect(()=>{const i=()=>{const c=new Date().toISOString();n&&console.debug("[HelloAuth] poke()",c),D(c)};p==null||p({poke:i})},[p,n]),o.useEffect(()=>{v()},[R,I,E,j,L]),null}),C=f.createMetadata({description:"`HelloAuth` is a headless auth service (no UI).",status:"experimental",props:{issuer:{description:"OIDC issuer.",type:"string",isRequired:!1},client_id:{description:"OIDC client id.",type:"string",isRequired:!1},redirect_uri:{description:"Redirect URI.",type:"string",isRequired:!1},scopes:{description:"Scopes (space-separated).",type:"string",isRequired:!1,defaultValue:d.scopes},storage:{description:"session | local",type:"string",isRequired:!1,defaultValue:d.storage},autoLogin:{description:"Attempt start on mount.",type:"boolean",isRequired:!1,defaultValue:d.autoLogin},debug:{description:"Console debug.",type:"boolean",isRequired:!1,defaultValue:d.debug},proxy_base_url:{description:"Optional proxy base, e.g. 'http://localhost:8080/proxy/'. If present, discovery and (later) token calls go through it.",type:"string",isRequired:!1},id:{description:"Component id.",type:"string",isRequired:!1}},events:{},apis:{poke:{description:"Update lastPokeAt in state.",type:"function"}}});return{namespace:"XMLUIExtensions",components:[f.createComponentRenderer("HelloAuth",C,({node:s,extractValue:t,registerComponentApi:h,updateState:A})=>{var m,u,w,n,a,p,g,H,O;return l.jsx(T,{id:t.asOptionalString((m=s.props)==null?void 0:m.id),issuer:t.asOptionalString((u=s.props)==null?void 0:u.issuer),client_id:t.asOptionalString((w=s.props)==null?void 0:w.client_id),redirect_uri:t.asOptionalString((n=s.props)==null?void 0:n.redirect_uri),scopes:t.asOptionalString((a=s.props)==null?void 0:a.scopes),storage:t.asOptionalString((p=s.props)==null?void 0:p.storage),autoLogin:t.asOptionalBoolean((g=s.props)==null?void 0:g.autoLogin),debug:t.asOptionalBoolean((H=s.props)==null?void 0:H.debug),proxy_base_url:t.asOptionalString((O=s.props)==null?void 0:O.proxy_base_url),registerComponentApi:h,updateState:A})})]}});typeof window.xmlui<"u"&&window.xmlui.standalone.registerExtension(window["xmlui-hello-auth"].default||window["xmlui-hello-auth"]);
