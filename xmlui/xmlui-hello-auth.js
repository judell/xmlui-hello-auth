(function(b,O){typeof exports=="object"&&typeof module<"u"?module.exports=O(require("react/jsx-runtime"),require("xmlui"),require("react")):typeof define=="function"&&define.amd?define(["react/jsx-runtime","xmlui","react"],O):(b=typeof globalThis<"u"?globalThis:b||self,b["xmlui-hello-auth"]=O(b.jsxRuntime,b.xmlui,b.React))})(this,function(b,O,p){"use strict";function F(e){try{const o=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),s=atob(o);return JSON.parse(s)}catch(o){return console.warn("Failed to parse ID token",o),null}}function J(e){const o=e.length%4?4-e.length%4:0,s=e.replace(/-/g,"+").replace(/_/g,"/")+"=".repeat(o),c=atob(s),S=new Uint8Array(c.length);for(let f=0;f<c.length;f++)S[f]=c.charCodeAt(f);return JSON.parse(new TextDecoder().decode(S))}function W(e){const[o,s]=e.split(".");return{header:J(o),payload:J(s)}}function X(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}async function G(e){const o=X(e),s=await crypto.subtle.digest("SHA-256",o);return new Uint8Array(s)}function B(e){let o="";for(let c=0;c<e.length;c++)o+=String.fromCharCode(e[c]);return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Q(e){return new TextEncoder().encode(e)}function C(e=32){const o=new Uint8Array(e);return crypto.getRandomValues(o),B(o)}async function Y(){const e=C(32),o=await G(Q(e)),s=B(o);return{verifier:e,challenge:s}}function H(e){return e==="local"?window.localStorage:window.sessionStorage}const _={scopes:"openid email profile",storage:"session",autoLogin:!1,debug:!0},Z=p.forwardRef(function({issuer:o,client_id:s,redirect_uri:c,scopes:S=_.scopes,storage:f=_.storage,autoLogin:$=_.autoLogin,debug:a=_.debug,proxy_base_url:v,registerComponentApi:T,updateState:x},L){const[E]=p.useState("idle"),[ee,te]=p.useState(void 0),[r,j]=p.useState(void 0),[oe,k]=p.useState(void 0),[h,I]=p.useState(void 0),[g,q]=p.useState(void 0),[ne,D]=p.useState(void 0),[se,U]=p.useState(void 0),[ie,R]=p.useState(void 0),A=p.useMemo(()=>`xmlui.auth:${o||"unknown"}:${s||"unknown"}`,[o,s]),re=p.useMemo(()=>({issuer:o,client_id:s,redirect_uri:c,scopes:S,storage:f,autoLogin:$,proxy_base_url:v}),[o,s,c,S,f,$,v]);function y(){const i={status:E,echo:re,endpoints:r,error:oe,temp:h,tokens:g,claims:ne,user:se,expiresAt:ie,lastPokeAt:ee};a&&console.debug("[HelloAuth] publish →",i),x==null||x(i)}p.useEffect(()=>{try{const i=new URL(window.location.href),t=i.searchParams,m=t.get("code"),d=t.get("state");if(!m)return;const u=H(f).getItem(A),n=u?JSON.parse(u):void 0;if(!n||!n.state||d!==n.state){a&&console.warn("[HelloAuth] callback: state mismatch or missing stash"),k({code:"redirect_state_mismatch",message:"State returned by the provider does not match the stored state.",details:{returnedState:d,expectedState:n==null?void 0:n.state}}),I(void 0),i.search="",window.history.replaceState({},document.title,i.toString()),setTimeout(y,0);return}k(void 0),I({code_verifier:n.code_verifier,state:n.state,nonce:n.nonce,code:m}),a&&console.debug("[HelloAuth] callback ✓ code captured"),i.search="",window.history.replaceState({},document.title,i.toString()),setTimeout(y,0)}catch(i){a&&console.warn("[HelloAuth] callback error",i)}},[A,f,a]),p.useEffect(()=>{(async()=>{if(!(!(h!=null&&h.code)||!(r!=null&&r.token_endpoint)||!s||!c))try{const i=v==null?void 0:v.replace(/\/+$/,""),t=r.token_endpoint.replace(/^https?:\/\//,""),m=i?`${i}/${t}`:r.token_endpoint,d=new URLSearchParams({grant_type:"authorization_code",code:h.code,client_id:s,redirect_uri:c,code_verifier:h.code_verifier||""});a&&(console.debug("[HelloAuth] token POST →",m),console.debug("[HelloAuth] token body →",Object.fromEntries(d.entries())));const w=await fetch(m,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:d});if(!w.ok){const l=await w.text().catch(()=>"");throw new Error(`HTTP ${w.status} ${w.statusText} :: ${l}`)}const u=await w.json();if(q(u),u.id_token){const l=F(u.id_token);l&&U({sub:l.sub,email:l.email,name:l.name,picture:l.picture})}k(void 0),a&&console.debug("[HelloAuth] token ✓",u);const n=H(f);try{n.removeItem(A)}catch{}setTimeout(y,0)}catch(i){const t=String((i==null?void 0:i.message)||i),m={code:t.includes("CORS")?"cors_blocked":"token_exchange_failed",message:"Failed to exchange authorization code for tokens",details:t};a&&console.warn("[HelloAuth] token ✗",m),q(void 0),k(m),setTimeout(y,0)}})()},[h==null?void 0:h.code,r==null?void 0:r.token_endpoint,s,c,v]),p.useEffect(()=>{(async()=>{if(g!=null&&g.id_token)try{const{header:i,payload:t}=W(g.id_token);if(a&&console.debug("[HelloAuth] id_token header/payload",i,t),r!=null&&r.issuer&&t.iss!==r.issuer)throw new Error(`iss mismatch: ${t.iss} !== ${r.issuer}`);if(s&&!(Array.isArray(t.aud)?t.aud.includes(s):t.aud===s))throw new Error("aud mismatch");const m=Math.floor(Date.now()/1e3);if(t.exp&&t.exp<=m)throw new Error(`id_token expired: exp=${t.exp}, now=${m}`);if(h!=null&&h.nonce&&t.nonce&&t.nonce!==h.nonce)throw new Error("nonce mismatch");const d={sub:t.sub,email:t.email,name:t.name||t.preferred_username||[t.given_name,t.family_name].filter(Boolean).join(" ")||void 0,picture:t.picture},w=typeof g.expires_in=="number"?Date.now()+g.expires_in*1e3:t.exp?t.exp*1e3:void 0;D(t),U(d),R(w),k(void 0);const u=H(f);try{u.setItem(`${A}:session`,JSON.stringify({user:d})),u.removeItem(A)}catch{}setTimeout(y,0)}catch(i){const t={code:"unknown",message:"ID token claim verification failed",details:String((i==null?void 0:i.message)||i)};a&&console.warn("[HelloAuth] verify ✗",t),k(t),D(void 0),U(void 0),R(void 0),setTimeout(y,0)}})()},[g==null?void 0:g.id_token,r==null?void 0:r.issuer,s,h==null?void 0:h.nonce,A,f,a]);const z=p.useRef(null);return p.useEffect(()=>{var u;if(j(void 0),k(void 0),!o){y();return}const t=`${o.replace(/\/+$/,"")}/.well-known/openid-configuration`,m=(v==null?void 0:v.replace(/\/+$/,""))||void 0,d=t.replace(/^https?:\/\//,""),w=m?`${m}/${d}`:t;(u=z.current)==null||u.abort(),z.current=new AbortController,(async()=>{try{a&&console.debug("[HelloAuth] discovery →",w);const n=await fetch(w,{signal:z.current.signal});if(!n.ok)throw new Error(`HTTP ${n.status}`);const l=await n.json(),P={issuer:l.issuer,authorization_endpoint:l.authorization_endpoint,token_endpoint:l.token_endpoint,jwks_uri:l.jwks_uri,userinfo_endpoint:l.userinfo_endpoint,end_session_endpoint:l.end_session_endpoint||l.end_session_endpoint_url};a&&console.debug("[HelloAuth] discovery ✓",P),j(P),k(void 0),setTimeout(y,0)}catch(n){if((n==null?void 0:n.name)==="AbortError")return;const l={code:"discovery_failed",message:"Failed to load OIDC discovery document",details:String((n==null?void 0:n.message)||n)};a&&console.warn("[HelloAuth] discovery ✗",l),j(void 0),k(l),setTimeout(y,0)}})()},[o,v]),p.useEffect(()=>{const i=()=>{const d=new Date().toISOString();a&&console.debug("[HelloAuth] poke()",d),te(d),setTimeout(y,0)},t=async()=>{var K;if(!(r!=null&&r.authorization_endpoint)||!s||!c){a&&console.warn("[HelloAuth] login(): missing config"),k({code:"config_missing",message:"issuer/client_id/redirect_uri or endpoints are missing"}),setTimeout(y,0);return}if(!((K=window.crypto)!=null&&K.subtle)){k({code:"unknown",message:"Web Crypto not available"}),setTimeout(y,0);return}const{verifier:d,challenge:w}=await Y(),u=C(16),n=C(16),l=H(f),P={code_verifier:d,state:u,nonce:n,redirect_uri:c,client_id:s};l.setItem(A,JSON.stringify(P));const M=new URL(r.authorization_endpoint),ae=new URLSearchParams({response_type:"code",client_id:s,redirect_uri:c,scope:S||"openid",state:u,nonce:n,code_challenge:w,code_challenge_method:"S256"});M.search=ae.toString();const N=M.toString();a&&console.debug("[HelloAuth] built authorize URL:",N),I({code_verifier:d,state:u,nonce:n}),setTimeout(y,0),window.location.assign(N)},m=async()=>{a&&console.debug("[HelloAuth] logout()"),q(void 0),D(void 0),U(void 0),R(void 0),k(void 0),I(void 0);const d=H(f);try{d.removeItem(A),d.removeItem(`${A}:session`)}catch{}if(r!=null&&r.end_session_endpoint&&(g!=null&&g.id_token)){const w=new URL(r.end_session_endpoint),u=new URLSearchParams({id_token_hint:g.id_token,post_logout_redirect_uri:c||window.location.origin});w.search=u.toString();const n=w.toString();a&&console.debug("[HelloAuth] logout redirect →",n),window.location.assign(n)}else setTimeout(y,0)};T==null||T({poke:i,login:t,logout:m})},[T,r,s,c,S,f,A,a]),null}),V=O.createMetadata({description:"`HelloAuth` is a headless auth service (no UI).",status:"experimental",props:{issuer:{description:"OIDC issuer.",type:"string",isRequired:!1},client_id:{description:"OIDC client id.",type:"string",isRequired:!1},redirect_uri:{description:"Redirect URI.",type:"string",isRequired:!1},scopes:{description:"Scopes (space-separated).",type:"string",isRequired:!1,defaultValue:_.scopes},storage:{description:"session | local",type:"string",isRequired:!1,defaultValue:_.storage},autoLogin:{description:"Attempt start on mount.",type:"boolean",isRequired:!1,defaultValue:_.autoLogin},debug:{description:"Console debug.",type:"boolean",isRequired:!1,defaultValue:_.debug},proxy_base_url:{description:"Optional proxy base, e.g. 'http://localhost:8080/proxy/'. If present, discovery and (later) token calls go through it.",type:"string",isRequired:!1},id:{description:"Component id.",type:"string",isRequired:!1}},events:{},apis:{poke:{description:"Update lastPokeAt in state.",type:"function"},login:{description:"Start OIDC Authorization Code + PKCE redirect.",type:"function"},logout:{description:"Clear auth state and optionally redirect to end session endpoint.",type:"function"}}});return{namespace:"XMLUIExtensions",components:[O.createComponentRenderer("HelloAuth",V,({node:e,extractValue:o,registerComponentApi:s,updateState:c})=>{var S,f,$,a,v,T,x,L,E;return b.jsx(Z,{id:o.asOptionalString((S=e.props)==null?void 0:S.id),issuer:o.asOptionalString((f=e.props)==null?void 0:f.issuer),client_id:o.asOptionalString(($=e.props)==null?void 0:$.client_id),redirect_uri:o.asOptionalString((a=e.props)==null?void 0:a.redirect_uri),scopes:o.asOptionalString((v=e.props)==null?void 0:v.scopes),storage:o.asOptionalString((T=e.props)==null?void 0:T.storage),autoLogin:o.asOptionalBoolean((x=e.props)==null?void 0:x.autoLogin),debug:o.asOptionalBoolean((L=e.props)==null?void 0:L.debug),proxy_base_url:o.asOptionalString((E=e.props)==null?void 0:E.proxy_base_url),registerComponentApi:s,updateState:c})})]}});typeof window.xmlui<"u"&&window.xmlui.standalone.registerExtension(window["xmlui-hello-auth"].default||window["xmlui-hello-auth"]);
