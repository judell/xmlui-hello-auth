(function(_,x){typeof exports=="object"&&typeof module<"u"?module.exports=x(require("react/jsx-runtime"),require("xmlui"),require("react")):typeof define=="function"&&define.amd?define(["react/jsx-runtime","xmlui","react"],x):(_=typeof globalThis<"u"?globalThis:_||self,_["xmlui-hello-auth"]=x(_.jsxRuntime,_.xmlui,_.React))})(this,function(_,x,d){"use strict";function B(t){const o=t.length%4?4-t.length%4:0,i=t.replace(/-/g,"+").replace(/_/g,"/")+"=".repeat(o),c=atob(i),S=new Uint8Array(c.length);for(let u=0;u<c.length;u++)S[u]=c.charCodeAt(u);return JSON.parse(new TextDecoder().decode(S))}function F(t){const[o,i]=t.split(".");return{header:B(o),payload:B(i)}}function W(t){return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}async function X(t){const o=W(t),i=await crypto.subtle.digest("SHA-256",o);return new Uint8Array(i)}function J(t){let o="";for(let c=0;c<t.length;c++)o+=String.fromCharCode(t[c]);return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function G(t){return new TextEncoder().encode(t)}function P(t=32){const o=new Uint8Array(t);return crypto.getRandomValues(o),J(o)}async function Q(){const t=P(32),o=await X(G(t)),i=J(o);return{verifier:t,challenge:i}}function H(t){return t==="local"?window.localStorage:window.sessionStorage}const T={scopes:"openid email profile",storage:"session",autoLogin:!1,debug:!0},Y=d.forwardRef(function({issuer:o,client_id:i,redirect_uri:c,scopes:S=T.scopes,storage:u=T.storage,autoLogin:$=T.autoLogin,debug:a=T.debug,proxy_base_url:v,registerComponentApi:b,updateState:O},C){const[E]=d.useState("idle"),[V,ee]=d.useState(void 0),[r,L]=d.useState(void 0),[te,k]=d.useState(void 0),[p,U]=d.useState(void 0),[w,j]=d.useState(void 0),[oe,q]=d.useState(void 0),[ne,R]=d.useState(void 0),[se,D]=d.useState(void 0),A=d.useMemo(()=>`xmlui.auth:${o||"unknown"}:${i||"unknown"}`,[o,i]),ie=d.useMemo(()=>({issuer:o,client_id:i,redirect_uri:c,scopes:S,storage:u,autoLogin:$,proxy_base_url:v}),[o,i,c,S,u,$,v]);function g(){const s={status:E,echo:ie,endpoints:r,error:te,temp:p,tokens:w,claims:oe,user:ne,expiresAt:se,lastPokeAt:V};a&&console.debug("[HelloAuth] publish →",s),O==null||O(s)}d.useEffect(()=>{try{const s=new URL(window.location.href),e=s.searchParams,h=e.get("code"),l=e.get("state");if(!h)return;const m=H(u).getItem(A),n=m?JSON.parse(m):void 0;if(!n||!n.state||l!==n.state){a&&console.warn("[HelloAuth] callback: state mismatch or missing stash"),k({code:"redirect_state_mismatch",message:"State returned by the provider does not match the stored state.",details:{returnedState:l,expectedState:n==null?void 0:n.state}}),U(void 0),s.search="",window.history.replaceState({},document.title,s.toString()),setTimeout(g,0);return}k(void 0),U({code_verifier:n.code_verifier,state:n.state,nonce:n.nonce,code:h}),a&&console.debug("[HelloAuth] callback ✓ code captured"),s.search="",window.history.replaceState({},document.title,s.toString()),setTimeout(g,0)}catch(s){a&&console.warn("[HelloAuth] callback error",s)}},[A,u,a]),d.useEffect(()=>{(async()=>{if(!(!(p!=null&&p.code)||!(r!=null&&r.token_endpoint)||!i||!c))try{const s=v==null?void 0:v.replace(/\/+$/,""),e=r.token_endpoint.replace(/^https?:\/\//,""),h=s?`${s}/${e}`:r.token_endpoint,l=new URLSearchParams({grant_type:"authorization_code",code:p.code,client_id:i,redirect_uri:c,code_verifier:p.code_verifier||""});a&&(console.debug("[HelloAuth] token POST →",h),console.debug("[HelloAuth] token body →",Object.fromEntries(l.entries())));const f=await fetch(h,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:l});if(!f.ok){const y=await f.text().catch(()=>"");throw new Error(`HTTP ${f.status} ${f.statusText} :: ${y}`)}const m=await f.json();j(m),k(void 0),a&&console.debug("[HelloAuth] token ✓",m);const n=H(u);try{n.removeItem(A)}catch{}setTimeout(g,0)}catch(s){const e=String((s==null?void 0:s.message)||s),h={code:e.includes("CORS")?"cors_blocked":"token_exchange_failed",message:"Failed to exchange authorization code for tokens",details:e};a&&console.warn("[HelloAuth] token ✗",h),j(void 0),k(h),setTimeout(g,0)}})()},[p==null?void 0:p.code,r==null?void 0:r.token_endpoint,i,c,v]),d.useEffect(()=>{(async()=>{if(w!=null&&w.id_token)try{const{header:s,payload:e}=F(w.id_token);if(a&&console.debug("[HelloAuth] id_token header/payload",s,e),r!=null&&r.issuer&&e.iss!==r.issuer)throw new Error(`iss mismatch: ${e.iss} !== ${r.issuer}`);if(i&&!(Array.isArray(e.aud)?e.aud.includes(i):e.aud===i))throw new Error("aud mismatch");const h=Math.floor(Date.now()/1e3);if(e.exp&&e.exp<=h)throw new Error(`id_token expired: exp=${e.exp}, now=${h}`);if(p!=null&&p.nonce&&e.nonce&&e.nonce!==p.nonce)throw new Error("nonce mismatch");const l={sub:e.sub,email:e.email,name:e.name||e.preferred_username||[e.given_name,e.family_name].filter(Boolean).join(" ")||void 0,picture:e.picture},f=typeof w.expires_in=="number"?Date.now()+w.expires_in*1e3:e.exp?e.exp*1e3:void 0;q(e),R(l),D(f),k(void 0);const m=H(u);try{m.setItem(`${A}:session`,JSON.stringify({tokens:w,claims:e,user:l,expires_at:f}))}catch{}setTimeout(g,0)}catch(s){const e={code:"unknown",message:"ID token claim verification failed",details:String((s==null?void 0:s.message)||s)};a&&console.warn("[HelloAuth] verify ✗",e),k(e),q(void 0),R(void 0),D(void 0),setTimeout(g,0)}})()},[w==null?void 0:w.id_token,r==null?void 0:r.issuer,i,p==null?void 0:p.nonce,A,u,a]);const z=d.useRef(null);return d.useEffect(()=>{var m;if(L(void 0),k(void 0),!o){g();return}const e=`${o.replace(/\/+$/,"")}/.well-known/openid-configuration`,h=(v==null?void 0:v.replace(/\/+$/,""))||void 0,l=e.replace(/^https?:\/\//,""),f=h?`${h}/${l}`:e;(m=z.current)==null||m.abort(),z.current=new AbortController,(async()=>{try{a&&console.debug("[HelloAuth] discovery →",f);const n=await fetch(f,{signal:z.current.signal});if(!n.ok)throw new Error(`HTTP ${n.status}`);const y=await n.json(),I={issuer:y.issuer,authorization_endpoint:y.authorization_endpoint,token_endpoint:y.token_endpoint,jwks_uri:y.jwks_uri,userinfo_endpoint:y.userinfo_endpoint,end_session_endpoint:y.end_session_endpoint||y.end_session_endpoint_url};a&&console.debug("[HelloAuth] discovery ✓",I),L(I),k(void 0),setTimeout(g,0)}catch(n){if((n==null?void 0:n.name)==="AbortError")return;const y={code:"discovery_failed",message:"Failed to load OIDC discovery document",details:String((n==null?void 0:n.message)||n)};a&&console.warn("[HelloAuth] discovery ✗",y),L(void 0),k(y),setTimeout(g,0)}})()},[o,v]),d.useEffect(()=>{const s=()=>{const l=new Date().toISOString();a&&console.debug("[HelloAuth] poke()",l),ee(l),setTimeout(g,0)},e=async()=>{var N;if(!(r!=null&&r.authorization_endpoint)||!i||!c){a&&console.warn("[HelloAuth] login(): missing config"),k({code:"config_missing",message:"issuer/client_id/redirect_uri or endpoints are missing"}),setTimeout(g,0);return}if(!((N=window.crypto)!=null&&N.subtle)){k({code:"unknown",message:"Web Crypto not available"}),setTimeout(g,0);return}const{verifier:l,challenge:f}=await Q(),m=P(16),n=P(16),y=H(u),I={code_verifier:l,state:m,nonce:n,redirect_uri:c,client_id:i};y.setItem(A,JSON.stringify(I));const M=new URL(r.authorization_endpoint),re=new URLSearchParams({response_type:"code",client_id:i,redirect_uri:c,scope:S||"openid",state:m,nonce:n,code_challenge:f,code_challenge_method:"S256"});M.search=re.toString();const K=M.toString();a&&console.debug("[HelloAuth] built authorize URL:",K),U({code_verifier:l,state:m,nonce:n}),setTimeout(g,0),window.location.assign(K)},h=async()=>{a&&console.debug("[HelloAuth] logout()"),j(void 0),q(void 0),R(void 0),D(void 0),k(void 0),U(void 0);const l=H(u);try{l.removeItem(A),l.removeItem(`${A}:session`)}catch{}if(r!=null&&r.end_session_endpoint&&(w!=null&&w.id_token)){const f=new URL(r.end_session_endpoint),m=new URLSearchParams({id_token_hint:w.id_token,post_logout_redirect_uri:c||window.location.origin});f.search=m.toString();const n=f.toString();a&&console.debug("[HelloAuth] logout redirect →",n),window.location.assign(n)}else setTimeout(g,0)};b==null||b({poke:s,login:e,logout:h})},[b,r,i,c,S,u,A,a]),null}),Z=x.createMetadata({description:"`HelloAuth` is a headless auth service (no UI).",status:"experimental",props:{issuer:{description:"OIDC issuer.",type:"string",isRequired:!1},client_id:{description:"OIDC client id.",type:"string",isRequired:!1},redirect_uri:{description:"Redirect URI.",type:"string",isRequired:!1},scopes:{description:"Scopes (space-separated).",type:"string",isRequired:!1,defaultValue:T.scopes},storage:{description:"session | local",type:"string",isRequired:!1,defaultValue:T.storage},autoLogin:{description:"Attempt start on mount.",type:"boolean",isRequired:!1,defaultValue:T.autoLogin},debug:{description:"Console debug.",type:"boolean",isRequired:!1,defaultValue:T.debug},proxy_base_url:{description:"Optional proxy base, e.g. 'http://localhost:8080/proxy/'. If present, discovery and (later) token calls go through it.",type:"string",isRequired:!1},id:{description:"Component id.",type:"string",isRequired:!1}},events:{},apis:{poke:{description:"Update lastPokeAt in state.",type:"function"},login:{description:"Start OIDC Authorization Code + PKCE redirect.",type:"function"},logout:{description:"Clear auth state and optionally redirect to end session endpoint.",type:"function"}}});return{namespace:"XMLUIExtensions",components:[x.createComponentRenderer("HelloAuth",Z,({node:t,extractValue:o,registerComponentApi:i,updateState:c})=>{var S,u,$,a,v,b,O,C,E;return _.jsx(Y,{id:o.asOptionalString((S=t.props)==null?void 0:S.id),issuer:o.asOptionalString((u=t.props)==null?void 0:u.issuer),client_id:o.asOptionalString(($=t.props)==null?void 0:$.client_id),redirect_uri:o.asOptionalString((a=t.props)==null?void 0:a.redirect_uri),scopes:o.asOptionalString((v=t.props)==null?void 0:v.scopes),storage:o.asOptionalString((b=t.props)==null?void 0:b.storage),autoLogin:o.asOptionalBoolean((O=t.props)==null?void 0:O.autoLogin),debug:o.asOptionalBoolean((C=t.props)==null?void 0:C.debug),proxy_base_url:o.asOptionalString((E=t.props)==null?void 0:E.proxy_base_url),registerComponentApi:i,updateState:c})})]}});typeof window.xmlui<"u"&&window.xmlui.standalone.registerExtension(window["xmlui-hello-auth"].default||window["xmlui-hello-auth"]);
